name: Release

on:
     push:
          branches:
               - main
     workflow_dispatch:
          inputs:
               ref:
                    description: 'Git ref to publish (tag/branch/sha)'
                    required: true
                    default: 'v1.0.0'

permissions:
     contents: write
     issues: write
     pull-requests: write
     id-token: write

jobs:
     release:
          name: Release
          if: github.event_name == 'push'
          runs-on: ubuntu-latest
          steps:
               - name: Checkout
                 uses: actions/checkout@v4
                 with:
                      fetch-depth: 0 # required for semantic-release to analyze commits

               - name: Setup Node.js
                 uses: actions/setup-node@v4
                 with:
                      node-version: 'lts/*'
                      registry-url: 'https://registry.npmjs.org'

               - name: Install
                 run: npm ci

               - name: Test
                 run: npm test

               - name: Build
                 run: npm run build

               - name: Semantic Release
                 uses: cycjimmy/semantic-release-action@v4
                 env:
                      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                      # Enable npm provenance + trusted publishing (OIDC).
                      NPM_CONFIG_PROVENANCE: true
                 with:
                      extra_plugins: |
                           @semantic-release/git
                           @semantic-release/changelog
                           @semantic-release/exec

           publish:
                         name: Publish
                         if: github.event_name == 'workflow_dispatch'
                         runs-on: ubuntu-latest
                         steps:
                                    - name: Checkout
                                         uses: actions/checkout@v4
                                         with:
                                                       ref: ${{ inputs.ref }}

                                    - name: Setup Node.js
                                         uses: actions/setup-node@v4
                                         with:
                                                       node-version: 'lts/*'
                                                       registry-url: 'https://registry.npmjs.org'

                                    - name: Install
                                         run: npm ci

                                    - name: Test
                                         run: npm test

                                    - name: Build
                                         run: npm run build

                                    - name: Publish
                                         env:
                                                       NPM_CONFIG_PROVENANCE: true
                                         run: npm publish --provenance --access public
